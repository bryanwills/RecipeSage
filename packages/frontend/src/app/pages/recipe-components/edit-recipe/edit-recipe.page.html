<ion-header>
  <ion-toolbar color="nav">
    <ion-buttons slot="start">
      <ion-back-button [defaultHref]="defaultBackHref"></ion-back-button>
    </ion-buttons>
    @if (recipe.id) {
      <ion-title>{{ "pages.editRecipe.title.edit" | translate }}</ion-title>
    }
    @if (!recipe.id) {
      <ion-title>{{ "pages.editRecipe.title.new" | translate }}</ion-title>
    }

    <ion-buttons slot="end">
      <ion-button (click)="presentPopover($event)">
        <ion-icon name="options" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <multi-image-upload
    [images]="images"
    (onImageAdded)="markAsDirty()"
  ></multi-image-upload>

  <div class="ion-padding edit-contents-container">
    @if (!recipe.id) {
      <ion-button id="autoclip-popover-trigger">
        <ion-icon name="cut-outline" slot="start"></ion-icon>
        {{ "pages.editRecipe.showClipOptions" | translate }}
      </ion-button>
    }
    <ion-popover
      trigger="autoclip-popover-trigger"
      triggerAction="click"
      [isOpen]="isAutoclipPopoverOpen"
      (didPresent)="isAutoclipPopoverOpen = true"
      (didDismiss)="isAutoclipPopoverOpen = false"
      [showBackdrop]="false"
    >
      <ng-template>
        <ion-content>
          <ion-list>
            <ion-item
              button
              (click)="isAutoclipPopoverOpen = false; clipFromUrl()"
            >
              <ion-icon name="link" slot="start"></ion-icon>
              {{ "pages.editRecipe.autoclip" | translate }}
            </ion-item>
            <ion-item
              button
              (click)="isAutoclipPopoverOpen = false; clipFromText()"
            >
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              {{ "pages.editRecipe.clipText" | translate }}
            </ion-item>
            <ion-item
              button
              (click)="isAutoclipPopoverOpen = false; scanImage()"
            >
              <ion-icon name="camera" slot="start"></ion-icon>
              {{ "pages.editRecipe.scanImage" | translate }}
            </ion-item>
            <ion-item button (click)="isAutoclipPopoverOpen = false; scanPDF()">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              {{ "pages.editRecipe.scanPDF" | translate }}
            </ion-item>
          </ion-list>
        </ion-content>
      </ng-template>
    </ion-popover>
    <br />
    <br />
    <br />
    <ion-item class="recipe-input">
      <ion-input
        label="{{ 'pages.editRecipe.input.title' | translate }}"
        labelPlacement="stacked"
        [(ngModel)]="recipe.title"
        (ngModelChange)="markAsDirty()"
        type="text"
        value=""
        autocapitalize="on"
        autocorrect="on"
        spellcheck="true"
      ></ion-input>
    </ion-item>

    <ion-item class="recipe-input">
      <ion-textarea
        label="{{ 'pages.editRecipe.input.description' | translate }}"
        labelPlacement="stacked"
        [(ngModel)]="recipe.description"
        (ngModelChange)="markAsDirty()"
        auto-grow="true"
        type="text"
        value=""
        autocapitalize="on"
        autocorrect="on"
        spellcheck="true"
      ></ion-textarea>
    </ion-item>

    <div class="miniflex">
      <ion-item class="recipe-input">
        <ion-input
          label="{{ 'pages.editRecipe.input.yield' | translate }}"
          labelPlacement="stacked"
          [(ngModel)]="recipe.yield"
          (ngModelChange)="markAsDirty()"
          type="text"
          value=""
          autocapitalize="on"
          autocorrect="on"
          spellcheck="true"
        ></ion-input>
      </ion-item>

      <ion-item class="recipe-input">
        <ion-input
          label="{{ 'pages.editRecipe.input.activeTime' | translate }}"
          labelPlacement="stacked"
          [(ngModel)]="recipe.activeTime"
          (ngModelChange)="markAsDirty()"
          type="text"
          value=""
          autocapitalize="on"
          autocorrect="on"
          spellcheck="true"
        ></ion-input>
      </ion-item>

      <ion-item class="recipe-input">
        <ion-input
          label="{{ 'pages.editRecipe.input.totalTime' | translate }}"
          labelPlacement="stacked"
          [(ngModel)]="recipe.totalTime"
          (ngModelChange)="markAsDirty()"
          type="text"
          value=""
          autocapitalize="on"
          autocorrect="on"
          spellcheck="true"
        ></ion-input>
      </ion-item>

      <ion-item class="recipe-input">
        <ion-input
          label="{{ 'pages.editRecipe.input.source' | translate }}"
          labelPlacement="stacked"
          [(ngModel)]="recipe.source"
          (ngModelChange)="markAsDirty()"
          type="text"
          value=""
          autocapitalize="on"
          autocorrect="on"
          spellcheck="true"
        ></ion-input>
      </ion-item>

      <ion-item class="recipe-input">
        <ion-input
          label="{{ 'pages.editRecipe.input.sourceUrl' | translate }}"
          labelPlacement="stacked"
          [(ngModel)]="recipe.url"
          (ngModelChange)="markAsDirty()"
          type="url"
          value=""
          autocapitalize="on"
          autocorrect="on"
          spellcheck="true"
        ></ion-input>
      </ion-item>

      <div class="rating-lastMadeAt recipe-input">
        <div class="rating">
          <div class="rating-title">
            {{ "pages.editRecipe.input.rating" | translate }}
          </div>
          <rating
            [rating]="recipe.rating"
            (ratingChanged)="recipe.rating = $event"
            [enableEdit]="true"
          ></rating>
        </div>

        @if (recipe.lastMadeAt) {
          <ion-item>
            <ion-input
              label="{{ 'pages.editRecipe.input.lastMadeAt' | translate }}"
              labelPlacement="stacked"
              class="rs-date"
              type="date"
              [(ngModel)]="recipe.lastMadeAt"
              (ngModelChange)="markAsDirty()"
            />
          </ion-item>
        }
        @if (!recipe.lastMadeAt) {
          <div class="lastMadeAt">
            <div class="lastMadeAt-title">
              {{ "pages.editRecipe.input.lastMadeAt" | translate }}
            </div>
            <div>
              <ion-button
                (click)="setLastMadeAtToday()"
                fill="clear"
                size="small"
                mode="ios"
              >
                {{ "pages.editRecipe.input.lastMadeAt.never" | translate }}
              </ion-button>
            </div>
          </div>
        }
      </div>
    </div>

    <ion-item class="recipe-input">
      <ion-textarea
        label="{{ 'pages.editRecipe.input.ingredients' | translate }}"
        labelPlacement="stacked"
        [(ngModel)]="recipe.ingredients"
        (ngModelChange)="markAsDirty()"
        auto-grow="true"
        type="text"
        value=""
        autocapitalize="on"
        autocorrect="on"
        spellcheck="true"
      ></ion-textarea>
    </ion-item>

    <ion-item class="recipe-input">
      <ion-textarea
        label="{{ 'pages.editRecipe.input.instructions' | translate }}"
        labelPlacement="stacked"
        [(ngModel)]="recipe.instructions"
        (ngModelChange)="markAsDirty()"
        auto-grow="true"
        type="text"
        value=""
        autocapitalize="on"
        autocorrect="on"
        spellcheck="true"
      ></ion-textarea>
    </ion-item>

    <ion-item class="recipe-input">
      <ion-textarea
        label="{{ 'pages.editRecipe.input.notes' | translate }}"
        labelPlacement="stacked"
        [(ngModel)]="recipe.notes"
        (ngModelChange)="markAsDirty()"
        auto-grow="true"
        type="text"
        value=""
        autocapitalize="on"
        autocorrect="on"
        spellcheck="true"
      ></ion-textarea>
    </ion-item>

    <br />

    <div>
      <ion-item lines="none">
        <ion-label>
          <h2>{{ "pages.editRecipe.input.linkedRecipes" | translate }}</h2>
        </ion-label>
      </ion-item>

      <div class="recipelinks-container">
        @if (selectedLinkedRecipes.length === 0) {
          <ion-item lines="none">
            <ion-label class="ion-text-wrap">
              <p>
                {{ "pages.editRecipe.input.linkedRecipes.none" | translate }}
              </p>
            </ion-label>
          </ion-item>
        }

        @if (selectedLinkedRecipes.length > 0) {
          <div>
            @for (
              linkedRecipe of selectedLinkedRecipes;
              track linkedRecipe.id
            ) {
              <ion-item lines="none">
                @if (linkedRecipe.recipeImages.length) {
                  <ion-avatar slot="start">
                    <img
                      src="{{ linkedRecipe.recipeImages[0].image.location }}"
                    />
                  </ion-avatar>
                }
                @if (!linkedRecipe.recipeImages.length) {
                  <ion-avatar slot="start">
                    <img src="assets/imgs/logo_green_padded.png" />
                  </ion-avatar>
                }
                <ion-label>
                  <h2>{{ linkedRecipe.title }}</h2>
                </ion-label>
                <ion-button
                  slot="end"
                  fill="clear"
                  (click)="removeLinkedRecipe(linkedRecipe.id)"
                >
                  <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-item>
            }
          </div>
        }

        <select-recipe
          (selectedRecipeChange)="linkedRecipeSelected($event)"
          [includeAllFriends]="true"
          [enableSelectedState]="false"
        ></select-recipe>
      </div>
    </div>

    <br />

    <ion-item lines="none">
      <ion-label>
        <h2>{{ "pages.editRecipe.input.labels" | translate }}</h2>
      </ion-label>
    </ion-item>

    <div class="label-input-group-container">
      <div class="label-input-group">
        @if (labelGroups.length) {
          <ion-item lines="none">
            <ion-label>
              {{ "pages.editRecipe.input.uncatLabels" | translate }}
            </ion-label>
          </ion-item>
        }

        <select-multiple-items
          [items]="mapLabelsToSelectableItems(labelsForGroupId(labels, null))"
          [enableCreateNew]="true"
          [selectedItems]="
            mapLabelsToSelectableItems(labelsForGroupId(selectedLabels, null))
          "
          (selectedItemsChange)="selectedLabelsChange(null, $event)"
          (newItem)="addLabel($event, null)"
          [disallowedTitles]="disallowedTitleMap(labels, null)"
          [reserveSearchResultsHeight]="false"
          noSelectedItemsText="{{
            'pages.editRecipe.input.labels.noSelectedItems' | translate
          }}"
          noItemsText="{{
            'pages.editRecipe.input.labels.noItems' | translate
          }}"
          searchPlaceholderText="{{
            'pages.editRecipe.input.labels.search' | translate
          }}"
        ></select-multiple-items>
      </div>

      @for (labelGroup of labelGroups; track labelGroup) {
        <div class="label-input-group">
          <ion-item lines="none">
            <ion-label> {{ labelGroup.title }} </ion-label>
          </ion-item>
          <select-multiple-items
            [items]="
              mapLabelsToSelectableItems(
                labelsForGroupId(labels, labelGroup.id)
              )
            "
            [enableCreateNew]="true"
            [selectedItems]="
              mapLabelsToSelectableItems(
                labelsForGroupId(selectedLabels, labelGroup.id)
              )
            "
            (selectedItemsChange)="selectedLabelsChange(labelGroup.id, $event)"
            (newItem)="addLabel($event, labelGroup.id)"
            [disallowedTitles]="disallowedTitleMap(labels, labelGroup.id)"
            [reserveSearchResultsHeight]="false"
            noSelectedItemsText="{{
              'pages.editRecipe.input.labels.noSelectedItems' | translate
            }}"
            noItemsText="{{
              'pages.editRecipe.input.labels.noItemsGroup' | translate
            }}"
            searchPlaceholderText="{{
              'pages.editRecipe.input.labels.search' | translate
            }}"
          ></select-multiple-items>
        </div>
      }
    </div>

    <div class="ion-padding">
      @if (recipe.id) {
        <ion-button expand="block" (click)="save()" [disabled]="saving">
          {{ "pages.editRecipe.save" | translate }}
        </ion-button>
      }
      @if (!recipe.id) {
        <ion-button expand="block" (click)="save()" [disabled]="saving">
          {{ "pages.editRecipe.create" | translate }}
        </ion-button>
      }
    </div>
  </div>
</ion-content>
